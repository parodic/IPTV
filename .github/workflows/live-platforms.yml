name: Live Platforms
on:
  schedule:
    - cron: '15 16/2 * * *'
  workflow_dispatch:
jobs:
  merge-m3u:
    runs-on: ubuntu-22.04
    env:
      MERGED_M3U: "live_platforms.m3u"
      TIMEOUT: 15
      RETRY: 3
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: ä¸‹è½½å¹¶åˆå¹¶æ‰€æœ‰M3U
        run: |
          set +e
          M3U_URLS=(
            "https://sub.ottiptv.cc/huyayqk.m3u"
            "https://sub.ottiptv.cc/douyuyqk.m3u"
            "https://sub.ottiptv.cc/bililive.m3u"
            "https://sub.ottiptv.cc/yylunbo.m3u"
          )
          download() {
            local url=$1 out=$2 tmp=${out}.tmp attempt=1
            rm -f $tmp 2>/dev/null
            while [ $attempt -le $RETRY ]; do
              if wget -q --timeout=$TIMEOUT "$url" -O $tmp 2>/dev/null && [ -s $tmp ]; then
                mv $tmp $out 2>/dev/null
                echo "âœ… ä¸‹è½½æˆåŠŸï¼š$out"
                return 0
              fi
              sleep $attempt && attempt=$((attempt+1))
            done
            rm -f $tmp 2>/dev/null && echo "âš ï¸ ä¸‹è½½å¤±è´¥ï¼š$outï¼Œä¿ç•™æ—§æ–‡ä»¶"
          }
          find . -maxdepth 1 -name "*.m3u" -delete 2>/dev/null
          echo "ğŸ—‘ï¸  å‰ç½®æ¸…ç†å®Œæˆï¼šåˆ é™¤å½“å‰ç›®å½•æ‰€æœ‰æ—§çš„M3Uæ–‡ä»¶"
          echo "ğŸ“¥ å¼€å§‹ä¸‹è½½M3Uæºæ–‡ä»¶"
          for url in "${M3U_URLS[@]}"; do
            fn=$(basename "$url" | cut -d'?' -f1 | cut -d'&' -f1)
            download "$url" "$fn"
          done
          if [ -s "yylunbo.m3u" ]; then
            sed -i 's#https://sub.ottiptv.cc#https://yylunbo.ottiptv.cc#g' yylunbo.m3u
            echo "ğŸ”§ YYè½®æ’­åŸŸåæ›¿æ¢å®Œæˆï¼šsub â†’ yylunbo"
          fi
          echo "ğŸ”— å¼€å§‹åˆå¹¶ä¸º ${MERGED_M3U}"
          echo "#EXTM3U" > "${MERGED_M3U}" 2>/dev/null
          tmp=$(mktemp)
          touch "$tmp"
          for f in *.m3u; do 
            if [ -s "$f" ]; then 
              sed '1d' "$f" | grep -v '^$' >> "$tmp" 2>/dev/null
            fi
          done
          [ -s "$tmp" ] && awk 'NR%2==1{line=$0;next} !seen[$0]++{print line"\n"$0}' "$tmp" >> "${MERGED_M3U}" 2>/dev/null
          rm -f "$tmp" 2>/dev/null
          find . -maxdepth 1 -name "*.m3u" ! -name "${MERGED_M3U}" -delete 2>/dev/null
          echo "ğŸ—‘ï¸  å·²åˆ é™¤æºM3Uæ–‡ä»¶ï¼Œä»…ä¿ç•™ ${MERGED_M3U}"
          
      - name: æš‚å­˜æ–‡ä»¶
        run: git add "${{ env.MERGED_M3U }}"
        continue-on-error: true
        
      - name: æ‹‰å–æœ€æ–°ä»£ç å¹¶æäº¤æ¨é€
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          
          if git diff --cached --name-only | grep -q .; then
            git fetch origin main
            git commit -m "Live Platforms: $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M') (CST)"
            git push origin HEAD:$GITHUB_REF_NAME --force
            echo "âœ… æ‹‰å–æœ€æ–°ä»£ç å¹¶å¼ºåˆ¶æ¨é€å®Œæˆ"
          else
            echo "â„¹ï¸ æ— æ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡æäº¤å’Œæ¨é€"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
