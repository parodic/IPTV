name: EPG Update
on:
  schedule:
    - cron: '30 16,20,0,4,8,12 * * *'
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Update EPG Files
        run: |
          rm -rf e.xml e.xml.gz
          EPG_SOURCES=(
            "https://epg.112114.xyz/pp.xml"
            "http://e.erw.cc/all.xml"
            "https://epg.zsdc.eu.org/t.xml"
            "http://epg.51zmt.top:8000/e1.xml"
          )
          DOWNLOAD_SUCCESS=0
          for SOURCE in "${EPG_SOURCES[@]}"; do
            echo "å°è¯•ä¸‹è½½EPGæº: $SOURCE"
            wget -v -T 20 -O e.xml "$SOURCE" -t 2 || true
            if [ -f e.xml ] && [ -s e.xml ] && head -1 e.xml | grep -q "<?xml"; then
              echo "âœ… æˆåŠŸä¸‹è½½æœ‰æ•ˆEPGæº: $SOURCE"
              DOWNLOAD_SUCCESS=1
              break # åˆ æ‰æ— æ„ä¹‰çš„touch e.xml
            else
              echo "âŒ EPGæº $SOURCE ä¸‹è½½å¤±è´¥/ç©ºæ–‡ä»¶/éXMLï¼Œå°è¯•ä¸‹ä¸€ä¸ª"
              rm -f e.xml
            fi
          done
          if [ $DOWNLOAD_SUCCESS -eq 0 ]; then
            echo "âŒ æ‰€æœ‰EPGæºä¸‹è½½å¤±è´¥ï¼Œä»»åŠ¡ç»ˆæ­¢"
            exit 1
          fi
          echo "ğŸ”§ å¼€å§‹å‹ç¼©e.xmlåˆ°e.xml.gz"
          gzip -9 -c e.xml > e.xml.gz
          if [ ! -s e.xml.gz ]; then
            echo "âŒ å‹ç¼©æ–‡ä»¶ç”Ÿæˆå¤±è´¥"
            exit 1
          fi
          
      - name: æš‚å­˜æ–‡ä»¶
        run: git add -f e.xml e.xml.gz
        continue-on-error: true
          
      - name: æ‹‰å–æœ€æ–°ä»£ç å¹¶æäº¤æ¨é€
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          
          if git diff --cached --name-only | grep -q .; then
            git fetch origin main
            git commit -m "EPG Update: $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M') (CST)"
            git push origin HEAD:$GITHUB_REF_NAME --force
            echo "âœ… æ‹‰å–æœ€æ–°ä»£ç å¹¶å¼ºåˆ¶æ¨é€å®Œæˆ"
          else
            echo "â„¹ï¸ æ— æ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡æäº¤å’Œæ¨é€"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
